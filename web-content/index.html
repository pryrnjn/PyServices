<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Social Feed</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css">

</head>
<body class="col-sm-offset-1 col-sm-10" style="padding-top: 2%;">
<div>
    <div class="input-group">
        <input id="search_input" type="text" class="form-control"
               placeholder="Enter a query to search in Instagram+Twitter">
        <span class="input-group-btn">
        <button id="search_btn" class="btn btn-default" type="button">Search</button>
      </span>
    </div>
</div>
<div name="results" style="margin-top: 2%">
    <table id="dataTbl" class="display" cellspacing="0" width="100%"></table>
</div>
<script>
    /**
     * Created by pryrnjn on 6/1/17.
     */
    var FEED_URL = "/feed?q={searchTerm}";
    var FEED_URL = "http://localhost:8080/feed?q={searchTerm}";

    function fetchResults(key, cb) {
        if (typeof cb != "function") throw new Error("Invalid callback");
        $.get(FEED_URL.replace("{searchTerm}", key), cb)
            .fail(function (err) {
                alert(err.responseText);
//                throw new Error(err.responseText);
            });
    }

    function getSearchKey() {
        return $("#search_input").val();
    }

    function populateResultsTbl(data) {
        if (!$.fn.dataTable.isDataTable('#dataTbl')) {
            $('#dataTbl').dataTable({
                retrieve: true,
                paging: false,
                search: true,
                order: false,
                //data: data,
                columns: [
                    {title: "Content"},
                    {title: "Date", visible: false}
                ]
            });
        }
        var dataTbl = $('#dataTbl').dataTable();
        dataTbl.fnClearTable();
        if (data instanceof Array && data.length > 0) {
            dataTbl.fnAddData(data);
            // dataTbl.fnDraw();
        }
    }
    function search() {
        fetchResults(getSearchKey(), function (resp) {
            var data = [];
            for (var i in resp) {
                var record = resp[i];
                var html = "<div>"
                    + "<div>" + getImgWidget(record.img) + "</div>"
                    + "<div>" + record.text + "</div>"
                    + "<div>" + getLinkWidget(record.link, record.source) + " - " + getLinkWidget(record.owner.link, record.owner.name) + " " + new Date(record.created_at * 1000).toLocaleString() + "</div>"
                    + "</div>";
                data.push([html, record.created_at])
            }
            populateResultsTbl(data);
        })
    }
    function getImgWidget(src, width, height) {
        if (src)
            if (width && height)
                return "<img width='" + width + "' height='" + height + "' src='" + src + "'>";
            else
                return "<img src='" + src + "'>";
        return "";
    }

    function getLinkWidget(link, name) {
        if (link || name) {
            return "<a target='_blank' href='" + link + "'>" + name + "</a>";
        }
        return ""
    }
    function bindEvents() {
        $("#search_input").bind("enterKey", search)
        $("#search_btn").click(search)
    }

    bindEvents();
</script>
</body>
</html>